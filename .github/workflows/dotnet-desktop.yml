name: Build WPF Application

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build:
    runs-on: windows-latest
  
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup MSBuild
      uses: microsoft/setup-msbuild@v1
      with:
        vs-version: '[17.0, 18.0]'
    
    - name: Setup NuGet
      uses: NuGet/setup-nuget@v1
      with:
        nuget-version: 'latest'

    - name: Restore NuGet packages
      run: nuget restore SampleCSharpUI.sln
    
    - name: Build WPF Application
      run: msbuild SampleCSharpUI.sln /p:Configuration=Release /p:Platform="Any CPU"
      
    - name: Upload Build Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: SampleCSharpUI-${{ github.run_number }}
        path: |
          $(Build.ArtifactStagingDirectory)\**
          **\bin\Release\**
        retention-days: 7

    - name: Create ZIP (optional, resilient)
      if: always()
      shell: powershell
      run: |
        $zipName = "SampleCSharpUI-${{ github.run_number }}.zip"
        $outDir = "$(Build.ArtifactStagingDirectory)\"
        # Collect candidate paths (OutDir and any project bin\Release)
        $paths = @()
        if (Test-Path $outDir) { $paths += $outDir }
          $paths += (Get-ChildItem -Path . -Recurse -Directory -Filter 'bin' -ErrorAction SilentlyContinue |
            ForEach-Object { Join-Path $_.FullName 'Release' } |
            Where-Object { Test-Path $_ } )
            if ($paths.Count -eq 0) {
              Write-Host "No build outputs found to zip. Skipping ZIP creation."
              exit 0
        }
        $items = @()
        foreach ($p in $paths) {
          $items += (Get-ChildItem -Path $p -Recurse -File | Select-Object -ExpandProperty FullName)
        }
        if ($items.Count -eq 0) {
          Write-Host "No files found in output folders. Skipping ZIP creation."
          exit 0
        }
        Compress-Archive -Path $items -DestinationPath $zipName -Force
        echo "ZIP_FILE=$zipName" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
        
    - name: Confirm ZIP exists
      shell: powershell
      run: |
        if (-not (Test-Path $env:ZIP_FILE)) {
          Write-Host "ZIP file not found: $env:ZIP_FILE"
          exit 0
        }
        Write-Host "ZIP file ready: $env:ZIP_FILE"

    - name: Create GitHub Release (only if ZIP was created)
      if: env.ZIP_FILE != ''
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: v${{ github.run_number }}
        release_name: "Build ${{ github.run_number }}"
        body: "Automated build created by workflow ${{ github.workflow }} run ${{ github.run_number }}"
        draft: false
        prerelease: false

    - name: Upload ZIP to Release
      if: env.ZIP_FILE != ''
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: ${{ env.ZIP_FILE }}
        asset_name: ${{ env.ZIP_FILE }}
        asset_content_type: application/zip
