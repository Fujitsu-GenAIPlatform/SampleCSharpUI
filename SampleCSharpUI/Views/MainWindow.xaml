<Window x:Class="SampleCSharpUI.Views.MainWindow"
        x:Name="window"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:i="http://schemas.microsoft.com/xaml/behaviors"
        xmlns:local="clr-namespace:SampleCSharpUI.Views"
        xmlns:prop="clr-namespace:SampleCSharpUI.Properties"
        xmlns:converter="clr-namespace:SampleCSharpUI.Converters"
        Icon="/Images/GAP_ICON2.ico"
        mc:Ignorable="d"
        FontFamily="Meiryo UI"
        Title="Windows UI Sample for Fujitsu Cloud Service Generative AI Platform" Height="450" Width="800"
        DataContext="{Binding ViewModel, RelativeSource={RelativeSource Mode=Self}}"
        d:DataContext="{d:DesignInstance IsDesignTimeCreatable=False}">
    <Window.Resources>
        <converter:NegativeConverter x:Key="NegativeConverter"/>
        <converter:Boolean2CollapsedConverter x:Key="Boolean2CollapsedConverter"/>
        <converter:Boolean2VisibilityConverter x:Key="Boolean2VisibilityConverter"/>
    </Window.Resources>

    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto" />
            <RowDefinition Height="Auto" />
            <RowDefinition />
            <RowDefinition Height="Auto" />
            <RowDefinition Height="Auto" />
        </Grid.RowDefinitions>

        <StackPanel Grid.Row="1" Orientation="Horizontal" Margin="8,0,8,0" Visibility="Collapsed">
        </StackPanel>

        <ListBox x:Name="listBoxMessage" Grid.Row="2" HorizontalContentAlignment="Stretch"
                 ScrollViewer.HorizontalScrollBarVisibility="Disabled"
                 ScrollViewer.VerticalScrollBarVisibility="Visible"
                 VirtualizingPanel.IsVirtualizing="True"
                 VirtualizingPanel.ScrollUnit="Pixel"
                 ScrollViewer.IsDeferredScrollingEnabled="False"
                 ScrollViewer.PanningMode="VerticalOnly"
                 SelectionMode="Single" Margin="0,0,0,0" Padding="20,0,20,0"
                 BorderThickness="0" Background="Transparent" Focusable="False"
                 ItemsSource="{Binding Messages}" >
            <ListBox.Style>
                <Style TargetType="{x:Type ListBox}">
                    <Setter Property="Template">
                        <Setter.Value>
                            <ControlTemplate TargetType="{x:Type ListBox}">
                                <Border Name="Bd"
                                        Background="{TemplateBinding Background}"
                                        BorderBrush="{TemplateBinding BorderBrush}"
                                        BorderThickness="{TemplateBinding BorderThickness}">
                                    <ScrollViewer Padding="{TemplateBinding Padding}"
                                                  Focusable="false">
                                        <ItemsPresenter SnapsToDevicePixels="{TemplateBinding SnapsToDevicePixels}"/>
                                    </ScrollViewer>
                                </Border>
                                <ControlTemplate.Triggers>
                                    <Trigger Property="IsEnabled" Value="false">
                                        <Setter TargetName="Bd" Property="Background" Value="Transparent"/>
                                    </Trigger>
                                </ControlTemplate.Triggers>
                            </ControlTemplate>
                        </Setter.Value>
                    </Setter>
                </Style>
            </ListBox.Style>
            <ListBox.ItemContainerStyle>
                <Style TargetType="ListBoxItem">
                    <Setter Property="Template">
                        <Setter.Value>
                            <ControlTemplate TargetType="{x:Type ContentControl}">
                                <ContentPresenter />
                            </ControlTemplate>
                        </Setter.Value>
                    </Setter>
                    <Setter Property="Margin" Value="0,0,0,0" />
                    <Setter Property="Padding" Value="0"/>
                    <Setter Property="BorderThickness" Value="0"/>
                    <Setter Property="Focusable" Value="False" />
                </Style>
            </ListBox.ItemContainerStyle>
            <ListBox.ItemTemplate>
                <DataTemplate>
                    <local:MessagePanel />
                </DataTemplate>
            </ListBox.ItemTemplate>
        </ListBox>

        <Grid Grid.Row="3" Margin="0,5,0,5" Visibility="{Binding IsLogin, Mode=OneWay, Converter={StaticResource Boolean2VisibilityConverter}}">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="Auto" />
                <ColumnDefinition Width="*" />
                <ColumnDefinition Width="Auto" />
                <ColumnDefinition Width="Auto" />
            </Grid.ColumnDefinitions>
            <Button Grid.Column="0" Margin="4,0,8,0" HorizontalAlignment="Left" ToolTip="ルームの設定を変更" Background="#FF707070" IsEnabled="{Binding IsBusy, Converter={StaticResource NegativeConverter}}">
                <Grid>
                    <Image Panel.ZIndex="1" Source="/Images/Settings.png"
                           Stretch="UniformToFill"
                           Width="24" Height="24" HorizontalAlignment="Center" VerticalAlignment="Center" />
                </Grid>
                <i:Interaction.Triggers>
                    <i:EventTrigger EventName="Click">
                        <i:InvokeCommandAction Command="{Binding ShowDialogCommand}" CommandParameter="EditChatRoomSettings"/>
                    </i:EventTrigger>
                </i:Interaction.Triggers>
            </Button>
            <TextBlock Grid.Column="2"  VerticalAlignment="Center" Opacity="0.6" Text="{Binding Messages.Count, StringFormat='メッセージ数: {0}'}" />
            <Button Grid.Column="3" Margin="4,0,4,0" ToolTip="最新会話を削除" Background="#FF707070" IsEnabled="{Binding IsBusy, Converter={StaticResource NegativeConverter}}">
                <Grid>
                    <Image Panel.ZIndex="1" Source="/Images/Trash.png"
                           Stretch="UniformToFill"
                           Width="24" Height="24" HorizontalAlignment="Center" VerticalAlignment="Center" />
                </Grid>
                <i:Interaction.Triggers>
                    <i:EventTrigger EventName="Click">
                        <i:InvokeCommandAction Command="{Binding DeleteMessageCommand}"/>
                    </i:EventTrigger>
                </i:Interaction.Triggers>
                <Button.Style>
                    <Style TargetType="Button">
                        <Setter Property="Visibility" Value="Visible" />
                        <Style.Triggers>
                            <DataTrigger Binding="{Binding Messages.Count}" Value="0">
                                <Setter Property="Visibility" Value="Hidden" />
                            </DataTrigger>
                        </Style.Triggers>
                    </Style>
                </Button.Style>
            </Button>
        </Grid>

        <Grid VerticalAlignment="Bottom" Grid.Row="4" Background="#FF707070" IsEnabled="{Binding IsLogin, Mode=OneWay}">
            <Grid  Margin="25,9,25,9">
                <TextBlock Text="ここに質問を入力しEnterキーを押してください。Tips:「なるべく簡素に」、「200文字以内で」のような指示を加えるとAIからの回答が短くなります。"
                           Padding="5,5,0,5" VerticalAlignment="Top" IsHitTestVisible="False" Background="White">
                </TextBlock>
                <TextBox Height="Auto" Padding="0,5,0,5"
                         Text="{Binding InputText, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                         TextWrapping="Wrap" BorderBrush="{Binding Background, RelativeSource={RelativeSource Self}}" 
                         BorderThickness="0" AcceptsReturn="True" >
                    <i:Interaction.Triggers>
                        <i:EventTrigger EventName="PreviewKeyDown">
                            <i:InvokeCommandAction Command="{Binding PreviewKeyDownCommand}" PassEventArgsToCommand="True" />
                        </i:EventTrigger>
                    </i:Interaction.Triggers>
                    <TextBox.Style>
                        <Style TargetType="TextBox">
                            <Setter Property="Background" Value="White"/>
                            <Setter Property="Opacity" Value="1.0"/>
                            <Style.Triggers>
                                <!-- ウォーターマーク表示: 空テキストかつフォーカスが当たっていない場合に表示 -->
                                <MultiDataTrigger>
                                    <MultiDataTrigger.Conditions>
                                        <Condition Binding="{Binding Text, RelativeSource={RelativeSource Self}}" Value=""/>
                                        <!--<Condition Binding="{Binding IsKeyboardFocused, RelativeSource={RelativeSource Self}}" Value="False"/>-->
                                    </MultiDataTrigger.Conditions>
                                    <Setter Property="Opacity" Value="0.5"/>
                                </MultiDataTrigger>
                                <!-- Busy表示 -->
                                <DataTrigger Binding="{Binding IsBusy, Mode=OneWay}" Value="True">
                                    <Setter Property="Background" Value="LightGray"/>
                                </DataTrigger>
                            </Style.Triggers>
                        </Style>
                    </TextBox.Style>
                </TextBox>
            </Grid>
        </Grid>

        <DockPanel Grid.Row="0" IsEnabled="{Binding IsBusy, Converter={StaticResource NegativeConverter}}">
            <Menu DockPanel.Dock="Top" Padding="0,4,0,4">
                <Menu.ItemsPanel>
                    <ItemsPanelTemplate>
                        <DockPanel />
                    </ItemsPanelTemplate>
                </Menu.ItemsPanel>
                <MenuItem Header="ファイル(_F)">
                    <MenuItem Header="RAG(_R)" IsEnabled="{Binding IsLogin}">
                        <MenuItem Command="{Binding ShowDialogCommand}" CommandParameter="CreateRetriever" Header="新規作成(_N)..." />
                        <MenuItem Command="{Binding ShowDialogCommand}" CommandParameter="ManageRetrievers" Header="開く(_O)..." />
                    </MenuItem>
                    <Separator />
                    <MenuItem Command="{Binding ShowDialogCommand}" CommandParameter="Connect" Header="接続(_C)..." Visibility="{Binding IsLogin, Converter={StaticResource Boolean2CollapsedConverter}}" IsEnabled="{Binding IsSettings}" />
                    <MenuItem Command="{Binding ShowDialogCommand}" CommandParameter="Disconnect" Header="切断(_D)" Visibility="{Binding IsLogin, Converter={StaticResource Boolean2VisibilityConverter}}" />
                    <MenuItem Command="{Binding ShowDialogCommand}" CommandParameter="Settings" Header="接続設定(_S)..." />
                    <Separator />
                    <MenuItem Header="終了(_X)">
                        <i:Interaction.Triggers>
                            <i:EventTrigger EventName="Click">
                                <i:CallMethodAction TargetObject="{Binding ElementName=window}" MethodName="Close" />
                            </i:EventTrigger>
                        </i:Interaction.Triggers>
                    </MenuItem>
                </MenuItem>
                <MenuItem Header="ルーム(_R)" IsEnabled="{Binding IsLogin}">
                    <MenuItem Command="{Binding ShowDialogCommand}" CommandParameter="CreateChatRoom" Header="新規作成(_N)..." />
                    <MenuItem Command="{Binding ShowDialogCommand}" CommandParameter="ManageChatRooms" Header="管理(_M)..." />
                    <Separator />
                    <MenuItem Command="{Binding ShowDialogCommand}" CommandParameter="ClearChatRoom" Header="会話をクリア(_C)" />
                </MenuItem>
                <ComboBox Foreground="Black" 
                          ItemsSource="{Binding ChatRooms}" 
                          SelectedItem="{Binding SelectedChatRoom}"
                          SelectedValuePath="ID"
                          Visibility="{Binding IsLogin, Converter={StaticResource Boolean2VisibilityConverter}}" IsEnabled="{Binding IsLogin}">
                    <ComboBox.ItemTemplate>
                        <DataTemplate>
                            <TextBlock Text="{Binding Name}" />
                        </DataTemplate>
                    </ComboBox.ItemTemplate>
                </ComboBox>
                <MenuItem Header="ヘルプ(_H)">
                    <MenuItem Command="{Binding ShowDialogCommand}" CommandParameter="About" Header="バージョン情報(_A)" />
                </MenuItem>
                <MenuItem Header="{Binding UserName}" DockPanel.Dock="Right" HorizontalAlignment="Right" IsHitTestVisible="False" Margin="0,0,20,0" />
            </Menu>
        </DockPanel>
    </Grid>
</Window>
